define(["util"],function(e){var t=function(){function t(t){var i=w().category,a=(D().missions,e("#tab-ul")),s=document.createDocumentFragment(),o=document.createElement("span"),r=0,d=e("#all-mission");o.className="delete-folder";for(var l=0,c=i.length;c>l;l++){var m=1,f=n(i[l],o,m,t);r+=parseInt(f.dataset.missionCount),s.appendChild(f)}a.innerHTML="",a.appendChild(s),d.innerHTML="所有任务 ("+r+")"}function n(t,n,i,a){var s=u(),o=0,r=document.createElement("li");r.className="tab-tree-li";var d=document.createElement("div");if(d.innerHTML=t.name,d.className="folder-name",d.dataset.folderId=t.folderId,d.appendChild(n.cloneNode()),"默认分类"===t.name&&(d.id="protected",a&&e.addClass(d,"font-active")),r.appendChild(d),t.children){for(var l=document.createElement("ul"),c=0;c<t.children.length;c++){var m;if(t.children[c].children)m=arguments.callee(t.children[c],n,i+1),o+=parseInt(m.dataset.missionCount);else{m=document.createElement("li"),m.innerHTML=t.children[c].name;for(var f=0,p=s.length;p>f;f++)if(t.children[c].taskId===s[f].taskId){o+=parseInt(s[f].count),m.innerHTML+=" ("+s[f].count+")";break}f===p&&(m.innerHTML+=" (0)"),m.dataset.taskId=t.children[c].taskId}l.appendChild(m)}r.appendChild(l),r.dataset.missionCount=o}return d.innerHTML+=" ("+o+")",r}function i(e,t){return"now"===e.time?-1:"now"===t.time?1:new Date(t.time).getTime()-new Date(e.time).getTime()}function a(e,t,n){for(var i=D().missions,a=0,s=i.length;s>a;a++)if(i[a].parentId===parseInt(e)){for(var o=i[a].children,r=0,d=o.length;d>r;r++)if(o[r].id===parseInt(t))return n?[a,r]:o[r];break}return null}function s(e,t){var n=d(e);n.push({name:t,folderId:w().folderIdCount++,children:[]}),y("category")}function o(e){var t=w().category;newCategory=r(t,e),w().category=newCategory,y("category"),g()}function r(t,n){if(null===t)return"Null";if(void 0===t)return"Undefined";var i,a,s=e.getType(t);if("Object"===s)a={};else if("Array"===s)a=[];else if("Number"===s||"String"===s||"Boolean"===s||"Date"===s)return t;for(i in t){var o=t[i];if("Object"===e.getType(o)||"Array"===e.getType(o))if("Array"===s){var r=arguments.callee(o,n);r&&a.push(r)}else a[i]=arguments.callee(o,n);else{if("folderId"===i&&o===n)return void(t=null);a[i]=t[i]}}return a}function d(e,t){var n=t||w().category;if(-1===e)return n;for(var i=0,a=n.length;a>i;i++){if(n[i].folderId===e)return n[i].children;if(n[i].children){var s=arguments.callee(e,n[i].children);if(s)return s}}return null}function l(){var e=O().oContMissionBody,t=e.dataset.parentId,n=e.dataset.missionId;return a(t,n)}function c(){var t=e("#mission-timeline .font-active");return a(t.dataset.parentId,t.dataset.missionId)}function m(e){for(var t=D().missions,n=0,i=t.length;i>n;n++)if(t[n].parentId===e)return void t[n].children.push({name:"新任务",time:"now",type:"unfinish",text:"新任务内容",id:D().missionId++});t.push({parentId:e,children:[{name:"新任务",time:"now",type:"unfinish",text:"新任务内容",id:D().missionId++}]})}function f(){var t=e("#cont-mission-body"),n=e("#cont-title-bar"),i=n.getElementsByTagName("h2")[0],a=e("#cont-mission-time span"),s=e("#finish-mission"),o=e("#edit-mission"),r=e("#save-edit"),d=e("#cancel-edit");n=null;var l={oContMissionBody:t,oMissionTitle:i,oMissionTime:a,oFinishBtn:s,oEditBtn:o,oSaveEdit:r,oCancelEdit:d};return function(){return l}}function u(){for(var e=D().missions,t=[],n=0,i=e.length;i>n;n++){var a={taskId:e[n].parentId,count:e[n].children.length};t.push(a)}return t}function p(e){var t=O();"edit"===e?(t.oFinishBtn.style.display=t.oEditBtn.style.display="none",t.oSaveEdit.style.display=t.oCancelEdit.style.display="block"):"see"===e&&(t.oFinishBtn.style.display=t.oEditBtn.style.display="block",t.oSaveEdit.style.display=t.oCancelEdit.style.display="none")}function g(){t(!1)}function h(t,n){var i,a=e("#mission-type"),s=a.getElementsByTagName("a");oTimelineOl=e("#mission-timeline ol"),targetSelect=void 0,a=null;for(var o=0;o<s.length;o++)e.hasClass(s[o],"type-active")&&(i=s[o]),s[o].dataset.type===t&&(targetSelect=s[o]);e.removeClass(i,"type-active"),e.addClass(targetSelect,"type-active");var r=e("#tab-ul .font-active");r&&"LI"===r.tagName.toUpperCase()&&(oTimelineOl.innerHTML="",oTimelineOl.appendChild(v(parseInt(e("#tabulation .font-active").dataset.taskId),t)),n&&oTimelineOl.getElementsByTagName("dd")[0].click())}function v(e,t){for(var n=D().missions,a=document.createDocumentFragment(),s=0,o=n.length;o>s;s++)if(n[s].parentId===e){var r=n[s].children;r.sort(i);for(var d=0,l=r.length;l>d;d++)if(r[d].type===t||"all"===t){var c=document.createElement("li"),m=document.createElement("dl"),f=document.createElement("dt"),u=document.createElement("dd");for(f.innerHTML=r[d].time,u.innerHTML=r[d].name,u.dataset.parentId=n[s].parentId,u.dataset.missionId=r[d].id,m.appendChild(f),m.appendChild(u);d!==l-1&&r[d].time===r[d+1].time;){d++;var p=document.createElement("dd");p.innerHTML=r[d].name,p.dataset.parentId=n[s].parentId,p.dataset.missionId=r[d].id,m.appendChild(p)}c.appendChild(m),a.appendChild(c)}break}if(s===o){var g=document.createElement("div");g.innerHTML="还没有任务哦<br/>点击下方添加任务",a.appendChild(g)}else if(!a.childElementCount){var g=document.createElement("div");g.innerHTML="这个任务类型下还没有任务",a.appendChild(g)}return a}function y(e){"category"===e?localStorage.setItem("category",JSON.stringify(w())):"missions"===e?localStorage.setItem("missions",JSON.stringify(D())):"all"===e&&(localStorage.setItem("category",JSON.stringify(w())),localStorage.setItem("missions",JSON.stringify(D())))}function I(){var e=JSON.parse(localStorage.getItem("category"))||{category:[{name:"百度IFE项目",folderId:1,children:[{name:"task1",taskId:1},{name:"task2",taskId:2},{name:"部分",folderId:2,children:[{name:"h1",taskId:3}]}]},{name:"毕业论文",folderId:4,children:[]},{name:"社团",folderId:5,children:[]},{name:"默认分类",folderId:0,children:[{name:"默认task",taskId:0}]}],taskIdCount:6,folderIdCount:5};return localStorage.getItem("category")||localStorage.setItem("category",JSON.stringify(e)),function(){return e}}function C(){var e=JSON.parse(localStorage.getItem("missions"))||{missions:[{parentId:0,children:[{name:"默认任务",time:"2015-06-01",type:"unfinish",id:0,text:"默认任务内容，什么都没有\n啊"}]},{parentId:1,children:[{name:"to-do-1",time:"2015-05-04",type:"unfinish",id:1,text:"adasdadadasds\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg\nasfsdgsgrgrgrgrg"},{name:"to-do-2",time:"2015-04-01",type:"finish",text:"rg",id:2},{name:"to-do-3",time:"2015-05-01",type:"finish",text:"rg1",id:3},{name:"to-do-4",time:"2015-04-30",type:"unfinish",text:"r",id:4},{name:"to-do-6",time:"2015-04-30",type:"unfinish",text:"r",id:5},{name:"to-do-9",time:"2015-04-30",type:"unfinish",text:"r",id:12}]},{parentId:2,children:[{name:"to-do-2",time:"2015-05-01",type:"finish",text:"rg",id:23},{name:"to-do-3",time:"2015-05-01",type:"finish",text:"rg1",id:34},{name:"to-do-4",time:"2015-04-30",type:"unfinish",text:"r",id:56}]}],missionId:56};return localStorage.getItem("missions")||localStorage.setItem("missions",JSON.stringify(e)),function(){return e}}function M(){try{T(),L(),k(),E(),S(),x(),H(),b(),B(),N()}catch(e){console.log(e)}}function T(){var t=e("#mission-type"),n=t.getElementsByTagName("a"),i=n[0],a=e("#mission-timeline ol"),t=null;e.delegate("#mission-type","a","click",function(){e.hasClass(this,"type-active")||(i=e("#mission-type .type-active")),e.removeClass(i,"type-active"),e.addClass(this,"type-active"),i=this;var t=e("#tab-ul .font-active");if(t&&"LI"===t.tagName.toUpperCase()){a.innerHTML="",a.appendChild(v(parseInt(e("#tabulation .font-active").dataset.taskId),this.dataset.type));for(var n=a.getElementsByTagName("dd"),s=0,o=n.length;o>s;s++)n[s].dataset.missionId===O().oContMissionBody.dataset.missionId&&e.addClass(n[s],"font-active")}})}function k(){var t=(e("#tab-ul"),D().missions,e("#mission-timeline ol")),n=e("#protected");e.delegate("#tab-ul","li","click",function(){e.hasClass(this,"tab-tree-li")||e.hasClass(this,"font-active")||(n&&e.removeClass(n,"font-active"),e.addClass(this,"font-active"),n=this,t.innerHTML="",t.appendChild(v(parseInt(this.dataset.taskId),e("#mission-type .type-active").dataset.type)))}),e.delegate("#tabulation","div","click",function(){e.hasClass(this,"font-active")||"tabulation"===this.id||"tab-title"===this.id||(n&&e.removeClass(n,"font-active"),e.addClass(this,"font-active"),n=this,t.innerHTML="请点击具体任务")})}function L(){var t;e.delegate("#mission-timeline ol","dd","click",function(){if(!e.hasClass(this,"font-active")){var n=O();if(e.hasClass(n.oContMissionBody,"mission-editing")){if(!confirm("正在编辑中，要放弃保存吗"))return;p("see"),e.removeClass(n.oContMissionBody,"mission-editing")}t&&e.removeClass(t,"font-active"),t=this,e.addClass(this,"font-active");var i=a(this.dataset.parentId,this.dataset.missionId);n.oMissionTitle.innerHTML=this.innerHTML,n.oMissionTime.innerHTML=i.time,n.oContMissionBody.innerHTML=i.text.replace(/\n/g,"<br/>"),n.oContMissionBody.dataset.parentId=this.dataset.parentId,n.oContMissionBody.dataset.missionId=this.dataset.missionId,n.oFinishBtn.style.display&&"none"!==n.oFinishBtn.style.display||(n.oFinishBtn.style.display=n.oEditBtn.style.display="block")}})}function E(){e.on("#edit-mission","click",function(){var t=O(),n=document.createElement("textarea");n.id="cont-mission-edit",n.innerHTML=e.htmlReturn(t.oContMissionBody.innerHTML).replace(/\<br\>/g,"\n"),t.oContMissionBody.innerHTML="",e.addClass(t.oContMissionBody,"mission-editing"),t.oContMissionBody.appendChild(n);var i=document.createElement("input");i.id="cont-title-edit",i.type="text",i.value=e.htmlReturn(t.oMissionTitle.innerHTML),t.oMissionTitle.innerHTML="",t.oMissionTitle.appendChild(i);var a=document.createElement("input");a.id="cont-time-edit",a.type="text",a.value="now"===t.oMissionTime.innerHTML?"yyyy-mm-dd":t.oMissionTime.innerHTML,t.oMissionTime.innerHTML="",t.oMissionTime.appendChild(a),p("edit")})}function H(){e.on("#save-edit","click",function(){var t=O(),n=e("#cont-mission-edit"),i=e("#cont-title-edit"),a=e("#cont-time-edit"),s=l();return Number(new Date(a.value).getTime())?(s.name=e.htmlEscape(i.value),s.time=e.htmlEscape(a.value),s.text=e.htmlEscape(n.value),y("missions"),t.oMissionTitle.innerHTML=s.name,t.oMissionTime.innerHTML=s.time,t.oContMissionBody.innerHTML=s.text.replace(/\n/g,"<br>"),e.removeClass(t.oContMissionBody,"mission-editing"),void p("see")):void alert("日期输入有误")})}function b(){e.on("#cancel-edit","click",function(){var t=O(),n=l();if(e.hasClass(t.oContMissionBody,"mission-editing")){if(!confirm("正在编辑中，要放弃保存吗"))return;p("see"),e.removeClass(t.oContMissionBody,"mission-editing"),t.oMissionTitle.innerHTML=n.name,t.oMissionTime.innerHTML=n.time,t.oContMissionBody.innerHTML=n.text.replace(/\n/g,"<br/>")}})}function B(){e.on("#finish-mission","click",function(){var e=c();return"finish"===e.type?void alert("任务已经完成啦"):void(confirm("确认完成任务吗?")&&(e.type="finish",alert("任务完成！"),y("missions")))})}function N(){e.delegate("#tab-ul","span","click",function(){if("protected"===this.parentNode.id)return void alert("默认文件夹不能删除");if(e.hasClass(this,"delete-folder")&&confirm("确定要删除这个文件夹吗")){var t=this.parentNode,n=parseInt(t.dataset.folderId);o(n)}})}function S(){e.on("#add-tab","click",function(){for(var t=prompt("在当前分类下添加分类，请输入分类名字","分类");""===e.trim(t);)alert("请输入分类名字呀"),t=prompt("在当前分类下添加分类，请输入分类名字","分类");if(null!==t){for(var n=e("#tabulation .font-active"),i=0;"DIV"!==n.tagName.toUpperCase();){n=n.parentNode;for(var a=e.getDomChildren(n),o=0,r=a.length;r>o;o++)"DIV"===a[o].tagName.toUpperCase()&&(n=a[o])}i="all-mission"===n.id?-1:parseInt(n.dataset.folderId),s(i,t),g()}})}function x(){e.on("#add-mission","click",function(){var t=e("#tab-ul .font-active");return"LI"!==t.tagName.toUpperCase()?void alert("请选择具体task来增加任务"):(m(parseInt(t.dataset.taskId)),h("all",!0),g(),void e("#edit-mission").click())})}var O=f(),w=I(),D=C();return function(){t(!0),M()}};return t});